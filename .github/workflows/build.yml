name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags (e.g., v1.0.0)
  workflow_dispatch:  # Allow manual triggers

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install .NET 10 Preview
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 10.0.x-preview

    - name: Install CMake
      uses: lukka/get-cmake@latest

    - name: Configure with CMake
      run: cmake -S . -B build

    - name: Build
      run: cmake --build build

    - name: Archive binaries
      run: |
        mkdir -p artifacts
        # Copy each architecture folder separately
        for arch in $(ls bin); do
          tar -czvf artifacts/${arch}.tar.gz -C bin/${arch} .
        done

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: binaries
        path: artifacts/
        if-no-files-found: error

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: binaries
        path: release-binaries

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release-binaries/*.tar.gz
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
